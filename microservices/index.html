<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Fernando Ruiz" /><link rel="canonical" href="https://grape-software.github.io/microservices/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Microservices - Grape Docs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Microservices";
        var mkdocs_page_input_path = "microservices.md";
        var mkdocs_page_url = "/microservices/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Grape Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../working/">Working</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../semantic-release/">Releasing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logs/">Logs</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../autocomplete/">Autocomplete</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../b4to5/">Bootstrap 4 to 5</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../http-services/">External Services</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../linter/">Linter Config</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../microfronts/">Microfronts</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Microservices</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#web-api-solution">Web Api solution</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#adding-core">Adding Core</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#web-api-packages">Web Api Packages</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#codigo-del-programcs">Código del Program.cs</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#agregado-de-appdbcontextcs">Agregado de AppDBContext.cs</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#appsettingsjson">appsettings.json</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../schema-compare/">Schema Compare</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../videos/">Videos snippets</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../powerbi/">Powerbi</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../environment-dev/">Environment Dev</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../neox/">Neox deploy</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Grape Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li><li>Microservices</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="microservices-grape-docs">Microservices Grape Docs</h1>
<h2 id="web-api-solution">Web Api solution</h2>
<pre><code class="language-shell">dotnet new sln --name MySolution
dotnet new classlib --output lib
dotnet sln add lib
dotnet new webapi --output services
dotnet sln add services
</code></pre>
<h2 id="adding-core">Adding Core</h2>
<p>Mostly a microservice use User and other business objects to build is own logic.
This should be done adding package Grape.Core from private repo https://github.com/grape-software/core/packages with the follow command:</p>
<pre><code>dotnet add PROJECT package Grape.Core --version X.X.X
</code></pre>
<h2 id="web-api-packages">Web Api Packages</h2>
<p>En el directorio del proyecto de APIs</p>
<pre><code class="language-shell">dotnet add package Microsoft.EntityFrameworkCore.SqlServer
dotnet add package Microsoft.EntityFrameworkCore.SqlServer.NetTopologySuite
dotnet add package Microsoft.AspNetCore.Mvc.NewtonsoftJson
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer
dotnet add package Newtonsoft.Json
dotnet add package Serilog.AspNetCore
dotnet add package Serilog.Enrichers.Environment
dotnet add package Serilog.Exceptions
dotnet add package Serilog.Exceptions.EntityFrameworkCore
dotnet add package Serilog.Settings.Configuration
dotnet add package Serilog.Sinks.Debug
dotnet add package Serilog.Sinks.MSSqlServer
dotnet add package Swashbuckle.AspNetCore
dotnet add package System.IdentityModel.Tokens.Jwt
dotnet add package System.Linq.Dynamic.Core
</code></pre>
<p>Código del archivo de proyecto</p>
<pre><code class="language-XML">  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net7.0&lt;/TargetFramework&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;RootNamespace&gt;&lt;/RootNamespace&gt;
    &lt;LangVersion&gt;latest&lt;/LangVersion&gt;
    &lt;GenerateDocumentationFile&gt;true&lt;/GenerateDocumentationFile&gt;
    &lt;NoWarn&gt;$(NoWarn);1591;1572;1573;&lt;/NoWarn&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
    &lt;VersionPrefix&gt;0.0.0&lt;/VersionPrefix&gt;
    &lt;VersionSuffix&gt;$([System.DateTime]::UtcNow.ToString(`yyyyMMdd-HHmm`))&lt;/VersionSuffix&gt;
  &lt;/PropertyGroup&gt;


  &lt;ItemGroup&gt;
    &lt;ProjectReference Include=&quot;..\lib\lib.csproj&quot; /&gt;
  &lt;/ItemGroup&gt;
</code></pre>
<h2 id="codigo-del-programcs">Código del Program.cs</h2>
<p>Con SQL Server este es el código</p>
<pre><code class="language-C#">using System.Diagnostics;
using System.Globalization;
using System.Reflection;
using System.Text;
using Microsoft.AspNetCore.Authentication.JwtBearer;
// using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using Microsoft.OpenApi.Models;
using Newtonsoft.Json;
using Serilog;
using Serilog.Exceptions;
using Serilog.Exceptions.Core;
using Serilog.Exceptions.EntityFrameworkCore.Destructurers;
using Swashbuckle.AspNetCore.SwaggerUI;

var builder = WebApplication.CreateBuilder(args);

// Get Application version to Log
var productVersion = &quot;&quot;;
var assembly = Assembly.GetExecutingAssembly();
var assemblyVersion = assembly.GetName().Version;
FileVersionInfo fvi = FileVersionInfo.GetVersionInfo(assembly.Location);
productVersion = fvi.ProductVersion ?? &quot;product version not found&quot;;

// For comments on OpenApi Swagger
var basePath = AppContext.BaseDirectory; //Microsoft.DotNet.PlatformAbstractions.ApplicationEnvironment.ApplicationBasePath;
var fileName = typeof(Program).GetTypeInfo().Assembly.GetName().Name + &quot;.xml&quot;;
var xmlCommentsPath = Path.Combine(basePath, fileName); ;

// Configuration
builder.Configuration.AddEnvironmentVariables(); // Add environment variables
// Write Log with Serilog
builder.Host.UseSerilog((ctx, lc) =&gt;
{
    lc.Enrich.FromLogContext();
    lc.Enrich.WithExceptionDetails(new DestructuringOptionsBuilder()
                .WithDefaultDestructurers()
                .WithDestructurers(new[] { new DbUpdateExceptionDestructurer() })
                );
    lc.Enrich.WithMachineName();
    lc.WriteTo.Debug();
    lc.WriteTo.Console();
    lc.Enrich.WithProperty(&quot;Version&quot;, productVersion);
    lc.ReadFrom.Configuration(ctx.Configuration);
});

builder.Services.AddControllers().AddNewtonsoftJson(x =&gt;
    {
        x.SerializerSettings.ReferenceLoopHandling = ReferenceLoopHandling.Ignore;
    });
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =&gt;
            {
                c.SwaggerDoc(&quot;v1&quot;, new OpenApiInfo
                {
                    Version = &quot;v1&quot;,
                    Title = &quot;Microservicio APIs&quot;,
                    Description = &quot;REST APIs del Microservicio&quot;,
                    TermsOfService = new Uri(&quot;http://www.DOMINIO.com.ar/&quot;),
                    Contact = new OpenApiContact
                    {
                        Name = &quot;Admin&quot;,
                        Email = &quot;mail@DOMINIO.com.ar&quot;,
                    },
                    License = new OpenApiLicense
                    {
                        Name = &quot;Use under LICX&quot;,
                        Url = new Uri(&quot;http://www.DOMINIO.com.ar/&quot;),
                    }
                });
                if (!string.IsNullOrWhiteSpace(xmlCommentsPath))
                    c.IncludeXmlComments(xmlCommentsPath);
            });

// string[] hostAuthorized = { &quot;http://localhost:4200&quot;, &quot;http://localhost:4205&quot;, &quot;http://localhost:8089&quot; };
builder.Services.AddCors(options =&gt;
{
    options.AddPolicy(&quot;CorsPolicy&quot;, builder =&gt; builder
        // Add urls to allows connection to signalr and rest of services
        // .WithOrigins(hostAuthorized)
        .SetIsOriginAllowed(origin =&gt; true) // allow any origin
        .AllowAnyMethod()
        .AllowAnyHeader()
        .AllowCredentials());
});
builder.Services.AddDbContextPool&lt;AppDBContext&gt;(c =&gt;
{
    //c.UseSqlite(sqliteString);
    c.UseSqlServer(builder.Configuration.GetConnectionString(&quot;Default&quot;), x =&gt; x.UseNetTopologySuite());
#if DEBUG
    c.EnableSensitiveDataLogging();
#endif
}, poolSize: 600);
var key = Encoding.ASCII.GetBytes(&quot;DefaultJWT&quot;);
var dbBuilder = new DbContextOptionsBuilder&lt;AppDBContext&gt;();
dbBuilder
// .EnableSensitiveDataLogging()
// .UseSqlite(sqliteString);
.UseSqlServer(builder.Configuration.GetConnectionString(&quot;Default&quot;), x =&gt; x.UseNetTopologySuite());
// .UseSnakeCaseNamingConvention()
// .UseNpgsql(Configuration.GetConnectionString(&quot;Default&quot;));

// WRN: Si la base no esta esto tira error
using (AppDBContext db = new AppDBContext(dbBuilder.Options))
{
    // db.Database.EnsureCreated(); // remove in production
    // JWT Secret
    key = Encoding.ASCII.GetBytes(db.SystemsParameters.FirstOrDefault(z =&gt; z.Code == &quot;JwtSecret&quot;)?.Value ?? &quot;Core2020-With-High-Security&quot;);
}

builder.Services.AddAuthentication(x =&gt;
{
    x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(x =&gt;
{
    x.RequireHttpsMetadata = false;
    x.SaveToken = true;
    x.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(key),
        ValidateIssuer = false,
        ValidateAudience = false
    };
});
builder.Services.AddHttpContextAccessor();


// builder.Services.AddHttpClient&lt;Services.Google.Maps&gt;(c =&gt;
// {
//     // Primero busca en la base si está configurada la URL del host y sino en archivo de configuracion
//     c.BaseAddress = new Uri(&quot;https://maps.googleapis.com&quot;);
// }); //.AddHttpMessageHandler&lt;ServiceHandler&gt;(); // Enrich Log when calling service;

var app = builder.Build();

// sets microservice default culture
var cultureInfo = new CultureInfo(&quot;es-AR&quot;);
CultureInfo.DefaultThreadCurrentCulture = cultureInfo;
CultureInfo.DefaultThreadCurrentUICulture = cultureInfo;


// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger(c =&gt; c.RouteTemplate = &quot;docs/{documentName}/swagger.json&quot;);
    app.UseSwaggerUI(c =&gt;
{
    c.RoutePrefix = &quot;docs&quot;;
    c.SwaggerEndpoint(&quot;v1/swagger.json&quot;, &quot;Documentación APIs&quot;);
    c.DocExpansion(DocExpansion.None);
});

}

app.UseHttpsRedirection();
app.UseCors(&quot;CorsPolicy&quot;);

// This allows to enrich without middleware but it does not have response data
// app.UseSerilogRequestLogging(opts =&gt; opts.EnrichDiagnosticContext = LogHelper.EnrichFromRequest);
//app.UseSerilogRequestLogging();
//app.UseMiddleware&lt;ApiLogMiddleware&gt;();

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();
</code></pre>
<h2 id="agregado-de-appdbcontextcs">Agregado de AppDBContext.cs</h2>
<pre><code class="language-C#">using Microsoft.EntityFrameworkCore;

public partial class AppDBContext : DbContext
{
    public AppDBContext(DbContextOptions options) : base(options)
    {
    }
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        // Evitar delete en cascada
        foreach (var relationship in modelBuilder.Model.GetEntityTypes().SelectMany(e =&gt; e.GetForeignKeys()))
        {
            relationship.DeleteBehavior = DeleteBehavior.Restrict;
        }

        // #region Auth
        // modelBuilder.Entity&lt;User&gt;(entity =&gt;
        // {
        //     entity.HasIndex(e =&gt; e.Identifier).IsUnique();
        //     entity.HasIndex(e =&gt; e.ExternalID);
        // });
        // #endregion

        // #region Enums
        // modelBuilder
        //     .Entity&lt;ConvenioCobro&gt;()
        //     .Property(e =&gt; e.FormaPago)
        //     .HasConversion&lt;string&gt;();
        // #endregion

        #region Views
        // modelBuilder.Entity&lt;EstadoFinancieroResult&gt;(e =&gt; e.ToView(&quot;EstadoFinanciero&quot;).HasNoKey());
        // modelBuilder.Entity&lt;CuentaCorrienteResult&gt;(e =&gt; e.ToView(&quot;CuentaCorriente&quot;).HasNoKey());
        #endregion
    }


}
</code></pre>
<h2 id="appsettingsjson">appsettings.json</h2>
<pre><code class="language-JSON">{
  &quot;Serilog&quot;: {
    &quot;MinimumLevel&quot;: {
      &quot;Default&quot;: &quot;Debug&quot;,
      &quot;Override&quot;: {
        &quot;Microsoft&quot;: &quot;Information&quot;,
        &quot;Microsoft.AspNetCore&quot;: &quot;Information&quot;,
        // To log all calls set this as Information
        &quot;Serilog.AspNetCore&quot;: &quot;Information&quot;,
        &quot;Microsoft.EntityFrameworkCore&quot;: &quot;Information&quot;
      }
    },
    &quot;WriteTo&quot;: [
      {
        &quot;Name&quot;: &quot;MSSqlServer&quot;,
        &quot;Args&quot;: {
          &quot;connectionString&quot;: &quot;Default&quot;,
          &quot;tableName&quot;: &quot;Logs&quot;,
          &quot;autoCreateSqlTable&quot;: true,
          &quot;logEventFormatter&quot;: &quot;Serilog.Formatting.Compact.CompactJsonFormatter, Serilog.Formatting.Compact&quot;,
          &quot;removeStandardColumns&quot;: [&quot;Properties&quot;],
          &quot;columnOptionsSection&quot;: {
            &quot;removeStandardColumns&quot;: [&quot;Properties&quot;, &quot;MessageTemplate&quot;],
            &quot;addStandardColumns&quot;: [&quot;LogEvent&quot;],
            &quot;logEvent&quot;: {
              &quot;excludeAdditionalProperties&quot;: true,
              &quot;excludeStandardColumns&quot;: true
            },
            &quot;customColumns&quot;: [
              {
                &quot;ColumnName&quot;: &quot;Elapsed&quot;,
                &quot;DataType&quot;: &quot;float&quot;
              },
              {
                &quot;ColumnName&quot;: &quot;StatusCode&quot;,
                &quot;DataType&quot;: &quot;int&quot;
              },
              {
                &quot;ColumnName&quot;: &quot;Version&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;,
                &quot;DataLength&quot;: 50
              },
              {
                &quot;ColumnName&quot;: &quot;RequestMethod&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;,
                &quot;DataLength&quot;: 10
              },
              {
                &quot;ColumnName&quot;: &quot;RequestPath&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;,
                &quot;DataLength&quot;: 300
              },
              {
                &quot;ColumnName&quot;: &quot;Authorization&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;
              },
              {
                &quot;ColumnName&quot;: &quot;Host&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;
              },
              {
                &quot;ColumnName&quot;: &quot;Protocol&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;
              },
              {
                &quot;ColumnName&quot;: &quot;Scheme&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;
              },
              {
                &quot;ColumnName&quot;: &quot;QueryString&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;
              },
              {
                &quot;ColumnName&quot;: &quot;RequestBody&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;
              },
              {
                &quot;ColumnName&quot;: &quot;ResponseBody&quot;,
                &quot;DataType&quot;: &quot;varchar&quot;
              }
            ]
          }
        }
      }
    ]
  },
  // Para loguear los bodies response y request
  &quot;SaveLogBodies&quot;: &quot;true&quot;,
  &quot;AllowedHosts&quot;: &quot;*&quot;,
  &quot;ConnectionStrings&quot;: {
    &quot;Default&quot;: &quot;Server=(local);Initial Catalog=XXXX;Persist Security Info=False;User ID=XXXX;Password=XXXX;MultipleActiveResultSets=True;Connection Timeout=30;TrustServerCertificate=True;&quot;
    // &quot;Default&quot;: &quot;Server=tcp:sql-docean.grape.com.ar,14330;Initial Catalog=XXXX;Persist Security Info=False;User ID=XXXX;Password=XXXXX;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=True;Connection Timeout=30;&quot;
  }
}

</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../microfronts/" class="btn btn-neutral float-left" title="Microfronts"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../schema-compare/" class="btn btn-neutral float-right" title="Schema Compare">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../microfronts/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../schema-compare/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
